<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="
https://cdn.jsdelivr.net/npm/modern-normalize@3.0.1/modern-normalize.min.css
" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="/favicon.png" type="image/png">
  <title>Create profile</title>
</head>
<body>
  <div>
    <h1>–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</h1>
    <form id="registerForm">
      <input type="text" name="username" placeholder="–Ü–º‚Äô—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞" required />
      <input id = "passwInput" type="password" name="password" placeholder="–ü–∞—Ä–æ–ª—å" required />
      <input type="checkbox" id="passwordToggle" name="passwordToggle" />–ü–æ–∫–∞–∑–∞—Ç–∏ –ø–∞—Ä–æ–ª—å
      <div id="passwStr"></div>
      <button type="submit">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
    </form>
  </div>

  <div> 
    <h1>–í—Ö—ñ–¥</h1>
    <form id="loginForm">
      <input type="text" name="username" placeholder="–Ü–º‚Äô—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞" required />
      <input type="password" name="password" placeholder="–ü–∞—Ä–æ–ª—å" required />
      <button type="submit">–£–≤—ñ–π—Ç–∏</button>
    </form>
  </div>
<p id="output"></p>
 <div id="profileCard" style="display:none; border: 1px solid #ccc; padding: 10px; margin-top: 20px; max-width: 250px;">
    <img src="profile.png" alt="Avatar" style="display:block; margin-bottom:10px; width: 50px"/>
    <div><strong>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á:</strong> <span id="profileUsername"></span></div>
    <div><strong>–†–æ–ª—å:</strong> <span id="profileRole"></span></div> 
    <button id="logoutBtn">–í–∏–π—Ç–∏ –∑ —Å–∏—Å—Ç–µ–º–∏</button>
</div>
<button id="adminPanelLink" style="display: none;">–ê–¥–º—ñ–Ω-–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</button>
<div id='adminContainer'> </div>
<h2 style="margin-top:20px; display: none;" id="listHeader">–°–ø–∏—Å–æ–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</h2>
<ul id="userList"></ul>
<script src="https://cdn.jsdelivr.net/npm/zxcvbn@4.4.2/dist/zxcvbn.js"></script>
<script src="https://unpkg.com/node-forge@1.0.0/dist/forge.min.js"></script>
  <script>
console.log(typeof forge);
    //–ü–µ—Ä–µ–≤—ñ—Ä—è—î, —á–∏ —Å–∞–π—Ç –≤—ñ–¥–∫—Ä–∏—Ç–∏–π –ª–æ–∫–∞–ª—å–Ω–æ 
    const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
     //–Ø–∫—â–æ —Å–∞–π—Ç –≤—ñ–¥–∫—Ä–∏—Ç–æ –ª–æ–∫–∞–ª—å–Ω–æ ‚Äî –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î http://localhost:5000.
    //–Ü–Ω–∞–∫—à–µ ‚Äî –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –∞–¥—Ä–µ—Å—É, –∑–∞–¥–µ–ø–ª–æ—î–Ω—É –Ω–∞ Render –∞–±–æ —ñ–Ω—à–∏–π —Ö–æ—Å—Ç–∏–Ω–≥.
    const API_BASE = isLocalhost
    ? 'http://localhost:5000'
    : 'https://dp-jha0.onrender.com';
    //—Ç—Ä–∏–º–∞–Ω–Ω—è –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ —ñ–∑ DOM
    const adminPanelLink = document.getElementById('adminPanelLink'); 
    const passwInput = document.getElementById('passwInput');
    const passwordToggle = document.getElementById('passwordToggle'); 
    const passwStr = document.getElementById('passwStr'); 
    const profileRole = document.getElementById('profileRole'); 
     const profileCard = document.getElementById('profileCard');
    const profileUsername = document.getElementById('profileUsername');
    const logoutBtn = document.getElementById('logoutBtn');
    const registerForm = document.getElementById('registerForm');
    const loginForm = document.getElementById('loginForm');
    const output = document.getElementById('output');
    const listHeader = document.getElementById('listHeader');
    adminPanelLink.style.display = 'none';
      let token =  sessionStorage.getItem('token') || '';
       function showProfile(username, role) {
      profileUsername.textContent = username;
        profileRole.textContent = role; 
      profileCard.style.display = 'block';
    }
    let currentUser = {};
  if(sessionStorage.getItem('token')){
    const payload = JSON.parse(atob(token.split('.')[1]));
 currentUser = {
  id: payload.id,
  username: payload.username,
  role: payload.role,
};
  }
function generateRSAKeyPair() {
  const keypair = forge.pki.rsa.generateKeyPair(2048);
  return {
    publicKey: forge.pki.publicKeyToPem(keypair.publicKey),
    privateKey: forge.pki.privateKeyToPem(keypair.privateKey)
  };
}

    // –§—É–Ω–∫—Ü—ñ—è —Å—Ö–æ–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å
    function hideProfile() {
      profileCard.style.display = 'none';
      profileUsername.textContent = '';
      profileRole.textContent = '';
      token = '';
      sessionStorage.removeItem('token');
      sessionStorage.removeItem('role');
      output.textContent = '–í–∏ –≤–∏–π—à–ª–∏ –∑ —Å–∏—Å—Ç–µ–º–∏';
    }


passwInput.addEventListener('input', () => {
  const password = passwInput.value;
  const result = zxcvbn(password);

  const score = result.score; // 0 - 4
  let feedback = "";

  if (score < 4) {
    feedback = '–ó–∞–Ω–∞–¥—Ç–æ —Å–ª–∞–±–∫–∏–π –ø–∞—Ä–æ–ª—å';
    passwInput.classList.remove('strong');
    passwInput.classList.add('weak');

    passwStr.classList.remove('strongFeed');
    passwStr.classList.add('weakFeed');
  } else {
    feedback = '–ü–∞—Ä–æ–ª—å –Ω–∞–¥—ñ–π–Ω–∏–π';
    passwInput.classList.remove('weak');
    passwInput.classList.add('strong');

    passwStr.classList.remove('weakFeed');
    passwStr.classList.add('strongFeed');
  }

  passwStr.innerHTML = `
    <p>–†—ñ–≤–µ–Ω—å –Ω–∞–¥—ñ–π–Ω–æ—Å—Ç—ñ: ${score} / 4</p>
    <p>${feedback}</p>
  `;
});


// –®–∏—Ñ—Ä—É—î–º–æ –ø—Ä–∏–≤–∞—Ç–Ω–∏–π –∫–ª—é—á —Ä—è–¥–∫–æ–º
async function encryptPrivateKey(privateKeyString, password) {
  const encoder = new TextEncoder();
  const salt = crypto.getRandomValues(new Uint8Array(16)); // —Å—ñ–ª—å
  const iv = crypto.getRandomValues(new Uint8Array(12));   // —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ–π–Ω–∏–π –≤–µ–∫—Ç–æ—Ä
  const key = await deriveKeyFromPassword(password, salt);
  const encrypted = await crypto.subtle.encrypt(
    { name: "AES-GCM", iv: iv },
    key,
    encoder.encode(privateKeyString)
  );
  return {
    encryptedData: new Uint8Array(encrypted),
    iv: iv,
    salt: salt
  };
}

function savePrivateKeyToIndexedDB(encryptedData, iv, salt) {
  // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —É IndexedDB –∑–∞ —Ç–≤–æ—î—é –ª–æ–≥—ñ–∫–æ—é,
  // –∞–ª–µ —Ç–µ–ø–µ—Ä –∑–∞–º—ñ—Å—Ç—å –≤—ñ–¥–∫—Ä–∏—Ç–æ–≥–æ –∫–ª—é—á–∞ –∑–±–µ—Ä—ñ–≥–∞—î—à:
  // encryptedData ‚Äî Uint8Array,
  // iv ‚Äî Uint8Array,
  // salt ‚Äî Uint8Array
  // –ú–æ–∂–Ω–∞ –ø–µ—Ä–µ—Ç–≤–æ—Ä–∏—Ç–∏ Uint8Array —É base64 –∞–±–æ –º–∞—Å–∏–≤ —á–∏—Å–µ–ª (—á–µ—Ä–µ–∑ Array.from) –ø–µ—Ä–µ–¥ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è–º.
    const request = indexedDB.open('CryptoKeysDB', 1);

  request.onupgradeneeded = function(event) {
    const db = event.target.result;
    if (!db.objectStoreNames.contains('keys')) {
      db.createObjectStore('keys');
    }
  };

  request.onsuccess = function(event) {
    const db = event.target.result;
    const transaction = db.transaction(['keys'], 'readwrite');
    const store = transaction.objectStore('keys');

    const encryptedPackage = {
      encryptedData: Array.from(encryptedData),
      iv: Array.from(iv),
      salt: Array.from(salt)
    };

    store.put(encryptedPackage, 'privateKey');
    console.log(encryptedPackage);
    console.log('–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π –ø—Ä–∏–≤–∞—Ç–Ω–∏–π –∫–ª—é—á –∑–±–µ—Ä–µ–∂–µ–Ω–æ –≤ IndexedDB');
  };

  request.onerror = function(event) {
    console.error('IndexedDB –ø–æ–º–∏–ª–∫–∞:', event.target.errorCode);
  };
}

async function decryptPrivateKey(encryptedData, iv, salt, password) {
  const key = await deriveKeyFromPassword(password, salt);
  const decrypted = await crypto.subtle.decrypt(
    { name: "AES-GCM", iv: iv },
    key,
    encryptedData
  );
  const decoder = new TextDecoder();
  return decoder.decode(decrypted);
}
function loadEncryptedPrivateKeyFromIndexedDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open('CryptoKeysDB', 1);

    request.onsuccess = function(event) {
      const db = event.target.result;
      const transaction = db.transaction(['keys'], 'readonly');
      const store = transaction.objectStore('keys');
      const getRequest = store.get('privateKey');

      getRequest.onsuccess = function() {
        const result = getRequest.result;
        if (result) {
          resolve({
            encryptedData: result.encryptedData,
            iv: result.iv,
            salt: result.salt
          });
        } else {
          resolve({}); // –ù–µ–º–∞—î –∫–ª—é—á–∞
        }
      };

      getRequest.onerror = function(event) {
        reject(event.target.error);
      };
    };

    request.onerror = function(event) {
      reject(event.target.error);
    };
  });
}
async function deriveKeyFromPassword(password, salt) {
  const encoder = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey(
    'raw',
    encoder.encode(password),
    'PBKDF2',
    false,
    ['deriveKey']
  );

  return await crypto.subtle.deriveKey(
    {
      name: 'PBKDF2',
      salt: salt,
      iterations: 100000,
      hash: 'SHA-256'
    },
    keyMaterial,
    { name: 'AES-GCM', length: 256 },
    false,
    ['encrypt', 'decrypt']
  );
}

async function fetchUsersList() {
  const savedToken = sessionStorage.getItem('token');
  if (!savedToken) {
    console.log('–°–ø–æ—á–∞—Ç–∫—É —É–≤—ñ–π–¥—ñ—Ç—å —É —Å–∏—Å—Ç–µ–º—É');
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/users`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${savedToken}`
      }
    });
    if (!res.ok) {
      const error = await res.json();
      console.log('–ü–æ–º–∏–ª–∫–∞:', error.message);
      return;
    }
    const users = await res.json();
    // console.log('–°–ø–∏—Å–æ–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤:', users);
       const list = document.getElementById('userList');
    list.innerHTML = ''; // –û—á–∏—â–∞—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π —Å–ø–∏—Å–æ–∫
    
    listHeader.style.display = 'block';
    users.forEach(user => {
      const li = document.createElement('li');
      li.textContent = `${user.username} ‚Äî —Ä–æ–ª—å: ${user.role}`;
      
    const deleteButton = document.createElement('button');
    deleteButton.style.display = 'none';
    deleteButton.classList.add('delete-button');
    if (currentUser.role === 'admin' && user.role !== 'admin') {
    deleteButton.style.display = 'inline-block';
    deleteButton.textContent = '–í–∏–¥–∞–ª–∏—Ç–∏';
  
    deleteButton.addEventListener('click', async () => {
      if (!confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü—å–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞?')) return;
    const userId = user._id;

    try {
      const response = await fetch(`/users/${userId}`, {
        method: 'DELETE',
        headers: {
    'Authorization': `Bearer ${token}`,
  }
      });

      if (response.ok) {
        console.log('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞', user.username, '–≤–∏–¥–∞–ª–µ–Ω–æ');
        deleteButton.closest('li')?.remove(); // –∞–±–æ –≤–∏–¥–∞–ª–∏ –∑ DOM —ñ–Ω—à–∏–π –µ–ª–µ–º–µ–Ω—Ç
        console.log("user deleted");
      } else {
        const error = await response.text();
        console.error('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è:', error);
      }
    } catch (err) {
      console.error("–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è:", err);
    }
  });
    li.appendChild(deleteButton);}


      
      list.appendChild(li);
    });
  } catch (e) {
    console.log('–ü–æ–º–∏–ª–∫–∞ –∑‚Äô—î–¥–Ω–∞–Ω–Ω—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º', e);
  }
}
passwordToggle.addEventListener('change', function () {
    passwInput.type = this.checked ? 'text' : 'password';
  });
registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      passwInput.type = 'password';
      //–ó–±–∏—Ä–∞—î –≤—Å—ñ –ø–æ–ª—è –∑ —Ñ–æ—Ä–º–∏ (username, password) —É –æ–±'—î–∫—Ç.
       const { publicKey, privateKey } = generateRSAKeyPair();
      const data = Object.fromEntries(new FormData(registerForm));
        const payload  = { ...data, publicKey }; 
      try {
        //–ù–∞–¥—Å–∏–ª–∞—î POST-–∑–∞–ø–∏—Ç –Ω–∞ /register (–ª–æ–∫–∞–ª—å–Ω–æ –∞–±–æ –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥—É).–ü–µ—Ä–µ–¥–∞—î –¥–∞–Ω—ñ —É —Ñ–æ—Ä–º–∞—Ç—ñ JSON.
        const res = await fetch(`${API_BASE}/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        // –û—Ç—Ä–∏–º—É—î –≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, { message: "–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞", privateKey: "..." }).
        // –í–∏–≤–æ–¥–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç —É –±–ª–æ–∫ output, –∫—Ä–∞—Å–∏–≤–æ —Ñ–æ—Ä–º–∞—Ç—É—é—á–∏ JSON.
        const result = await res.json();
        output.textContent = JSON.stringify(result, null, 2);
        if (res.ok && result.message) {
      // –Ø–∫—â–æ —É—Å–ø—ñ—Ö ‚Äî –ø–æ–∫–∞–∑—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑–µ–ª–µ–Ω–∏–º
      registerForm.reset();
      passwStr.innerHTML= '';
      passwInput.classList.remove('strong');
      }
         
   const password = data.password;
  const encryptedObj = await encryptPrivateKey(privateKey, password);

  // –ó–±–µ—Ä–µ–≥—Ç–∏ —É IndexedDB –Ω–µ –ø—Ä–∏–≤–∞—Ç–Ω–∏–π –∫–ª—é—á —É –≤—ñ–¥–∫—Ä–∏—Ç–æ–º—É –≤–∏–≥–ª—è–¥—ñ, –∞ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π –∑ iv —ñ salt
  savePrivateKeyToIndexedDB(encryptedObj.encryptedData, encryptedObj.iv, encryptedObj.salt);
      // savePrivateKeyToIndexedDB(result.privateKey);
    
        // –Ø–∫—â–æ —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π –∞–±–æ —Å—Ç–∞–ª–∞—Å—è —ñ–Ω—à–∞ –ø–æ–º–∏–ª–∫–∞ ‚Äî –≤–∏–≤–æ–¥–∏—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫—É
      } catch (err) {
        output.textContent = '–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —Å–µ—Ä–≤–µ—Ä–∞';
      }
    });

loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      //–û—Ç—Ä–∏–º—É—î –¥–∞–Ω—ñ –∑ –ø–æ–ª—ñ–≤ —Ñ–æ—Ä–º–∏ loginForm (–∑–∞–∑–≤–∏—á–∞–π username, password) —ñ —Ñ–æ—Ä–º—É—î –∑ –Ω–∏—Ö –æ–±'—î–∫—Ç.
      const data = Object.fromEntries(new FormData(loginForm));
      try {
        //–ù–∞–¥—Å–∏–ª–∞—î POST-–∑–∞–ø–∏—Ç –¥–æ /login, –ø–µ—Ä–µ–¥–∞—é—á–∏ JSON-–¥–∞–Ω—ñ –¥–ª—è –≤—Ö–æ–¥—É.
        const res = await fetch(`${API_BASE}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        // –ß–∏—Ç–∞—î JSON-–≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞. –Ø–∫—â–æ –≤—Ö—ñ–¥ —É—Å–ø—ñ—à–Ω–∏–π, –æ—Ç—Ä–∏–º–∞—î—à{ message: '–£—Å–ø—ñ—à–Ω–∏–π –≤—Ö—ñ–¥', token: 'JWT_–¢–û–ö–ï–ù' }
        const result = await res.json();
        if (res.ok) {
      // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ç–æ–∫–µ–Ω —É sessionStorage
      sessionStorage.setItem('token', result.token);
      sessionStorage.setItem('role', result.role);
      token = result.token;  // –û–Ω–æ–≤–ª—é—î–º–æ –ª–æ–∫–∞–ª—å–Ω—É –∑–º—ñ–Ω–Ω—É –¥–ª—è –ø–æ–¥–∞–ª—å—à–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤
      const payload = JSON.parse(atob(result.token.split('.')[1]));
  currentUser = {
    id: payload.id,
    username: payload.username,
    role: payload.role,
  };
const { encryptedData, iv, salt } = await loadEncryptedPrivateKeyFromIndexedDB();
  if (!encryptedData || !iv || !salt) {
    console.warn("–ü—Ä–∏–≤–∞—Ç–Ω–∏–π –∫–ª—é—á –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ IndexedDB.");
  } else {
    try {
      const privateKey = await decryptPrivateKey(
        new Uint8Array(encryptedData),
        new Uint8Array(iv),
        new Uint8Array(salt),
        data.password // –ø–∞—Ä–æ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
      );
      console.log("üîê –ü—Ä–∏–≤–∞—Ç–Ω–∏–π –∫–ª—é—á —Ä–æ–∑—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ:", privateKey);
      // üîí –¢–µ–ø–µ—Ä –º–æ–∂–µ—à –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ privateKey —É –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω—ñ–π –ø–∞–º'—è—Ç—ñ –∞–±–æ sessionStorage –ø—Ä–∏ –ø–æ—Ç—Ä–µ–±—ñ
    } catch (e) {
      console.error("‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è —Ä–æ–∑—à–∏—Ñ—Ä—É–≤–∞—Ç–∏ –ø—Ä–∏–≤–∞—Ç–Ω–∏–π –∫–ª—é—á. –ú–æ–∂–ª–∏–≤–æ, –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –ø–∞—Ä–æ–ª—å.");
      output.textContent = "–ù–µ –≤–¥–∞–ª–æ—Å—è —Ä–æ–∑—à–∏—Ñ—Ä—É–≤–∞—Ç–∏ –ø—Ä–∏–≤–∞—Ç–Ω–∏–π –∫–ª—é—á. –ú–æ–∂–ª–∏–≤–æ, –ø–∞—Ä–æ–ª—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π.";
      return;
    }
  }


      output.textContent = JSON.stringify(result, null, 2);
      showProfile(data.username, result.role); 

      const savedRole = sessionStorage.getItem('role');
      fetchUsersList();
      if (savedRole === 'admin') {
    adminPanelLink.style.display = 'block';
  } else{
    adminPanelLink.style.display = 'none';
  }
    } else {
       if (result.remainingAttempts !== undefined) {
    output.textContent = `${result.message}. –ó–∞–ª–∏—à–∏–ª–æ—Å—å —Å–ø—Ä–æ–±: ${result.remainingAttempts}`;
  } else {
    output.textContent = result.message || '–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É';
  }
    }
  
      } 
      // –Ø–∫—â–æ —Å—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ –∑ –º–µ—Ä–µ–∂–µ—é —á–∏ —Å–µ—Ä–≤–µ—Ä–æ–º ‚Äî –≤–∏–≤–æ–¥–∏—Ç—å—Å—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
      catch (err) {
      
          output.textContent = '–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —Å–µ—Ä–≤–µ—Ä–∞: ' + err.message;
  console.error(err);
      }
    });

adminPanelLink.addEventListener('click', async (e)=>{
        e.preventDefault();
  const savedToken = sessionStorage.getItem('token');
// console.log(savedToken);

  if (!savedToken) {
    output.textContent = '–°–ø–æ—á–∞—Ç–∫—É —É–≤—ñ–π–¥—ñ—Ç—å —É —Å–∏—Å—Ç–µ–º—É';
    return;
  }

 fetch('http://localhost:5000/admin', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    })
    .then(res => {
      if (!res.ok) throw new Error('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ');
      return res.text(); // –û—á—ñ–∫—É—î—Ç—å—Å—è, —â–æ —Å–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä–Ω–µ HTML
    })
    .then(html => {
    // –∑–∞–º—ñ–Ω—é—î –≤–µ—Å—å body
      // –∞–±–æ –≤—Å—Ç–∞–≤–∏—Ç–∏ —É –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π div:
      document.getElementById('adminContainer').innerHTML = html;
    })
    .catch(err => {
      console.error('–î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ:', err.message);
      alert('–£ –≤–∞—Å –Ω–µ–º–∞—î –¥–æ—Å—Ç—É–ø—É –¥–æ –ø–∞–Ω–µ–ª—ñ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞');
    });

    });


     logoutBtn.addEventListener('click', () => {
      sessionStorage.removeItem('token');
      document.getElementById('adminContainer').innerHTML = '';
      document.getElementById('userList').innerHTML = '';
      listHeader.style.display = 'none';
      adminPanelLink.style.display = 'none';
      
      hideProfile();
  });


  
  </script>
</body>
</html>
