<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="style.css" />
  <title>Create profile</title>
</head>
<body>
  <div>
    <h1>Реєстрація</h1>
    <form id="registerForm">
      <input type="text" name="username" placeholder="Ім’я користувача" required />
      <input type="password" name="password" placeholder="Пароль" required />
      <button type="submit">Зареєструватися</button>
    </form>
  </div>

  <div> 
    <h1>Вхід</h1>
    <form id="loginForm">
      <input type="text" name="username" placeholder="Ім’я користувача" required />
      <input type="password" name="password" placeholder="Пароль" required />
      <button type="submit">Увійти</button>
    </form>
  </div>
<p id="output"></p>
 <div id="profileCard" style="display:none; border: 1px solid #ccc; padding: 10px; margin-top: 20px; max-width: 250px;">
    <img src="profile.png" alt="Avatar" style="display:block; margin-bottom:10px; width: 50px"/>
    <div><strong>Користувач:</strong> <span id="profileUsername"></span></div>
    <div><strong>Роль:</strong> <span id="profileRole"></span></div> 
    <button id="logoutBtn">Вийти з системи</button>
</div>
<button id="adminPanelLink" style="display: none;">Адмін-панель</button>
<div id='adminContainer'> </div>
  <script>
    
    //Перевіряє, чи сайт відкритий локально 
    const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
     //Якщо сайт відкрито локально — використовує http://localhost:5000.
    //Інакше — використовує адресу, задеплоєну на Render або інший хостинг.
    const API_BASE = isLocalhost
    ? 'http://localhost:5000'
    : 'https://dp-jha0.onrender.com';
    //тримання елементів із DOM
    const adminPanelLink = document.getElementById('adminPanelLink'); 
    const profileRole = document.getElementById('profileRole'); 
     const profileCard = document.getElementById('profileCard');
    const profileUsername = document.getElementById('profileUsername');
    const logoutBtn = document.getElementById('logoutBtn');
    const registerForm = document.getElementById('registerForm');
    const loginForm = document.getElementById('loginForm');
    const output = document.getElementById('output');
    adminPanelLink.style.display = 'none';
      let token =  sessionStorage.getItem('token') || '';
       function showProfile(username, role) {
      profileUsername.textContent = username;
        profileRole.textContent = role; 
      profileCard.style.display = 'block';
    }

    // Функція сховати профіль
    function hideProfile() {
      profileCard.style.display = 'none';
      profileUsername.textContent = '';
      profileRole.textContent = '';
      token = '';
      sessionStorage.removeItem('token');
      sessionStorage.removeItem('role');
      output.textContent = 'Ви вийшли з системи';
    }

    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      //Збирає всі поля з форми (username, password) у об'єкт.
      const data = Object.fromEntries(new FormData(registerForm));
      try {
        //Надсилає POST-запит на /register (локально або на хостингу).Передає дані у форматі JSON.
        const res = await fetch(`${API_BASE}/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        // Отримує відповідь від сервера (наприклад, { message: "Реєстрація успішна", privateKey: "..." }).
        // Виводить результат у блок output, красиво форматуючи JSON.
        const result = await res.json();
        output.textContent = JSON.stringify(result, null, 2);
        // Якщо сервер недоступний або сталася інша помилка — виводить повідомлення про помилку
      } catch (err) {
        output.textContent = 'Помилка підключення до сервера';
      }
    });

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      //Отримує дані з полів форми loginForm (зазвичай username, password) і формує з них об'єкт.
      const data = Object.fromEntries(new FormData(loginForm));
      try {
        //Надсилає POST-запит до /login, передаючи JSON-дані для входу.
        const res = await fetch(`${API_BASE}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        // Читає JSON-відповідь від сервера. Якщо вхід успішний, отримаєш{ message: 'Успішний вхід', token: 'JWT_ТОКЕН' }
        const result = await res.json();
        if (res.ok) {
      // Зберігаємо токен у sessionStorage
      sessionStorage.setItem('token', result.token);
      sessionStorage.setItem('role', result.role);
      token = result.token;  // Оновлюємо локальну змінну для подальших запитів
      output.textContent = JSON.stringify(result, null, 2);
      showProfile(data.username, result.role); 

      console.log(token);

      const savedRole = sessionStorage.getItem('role');
      if (savedRole === 'admin') {
    adminPanelLink.style.display = 'block';
  } else{
    adminPanelLink.style.display = 'none';
  }
    } else {
      output.textContent = result.message || 'Помилка входу';
    }
  
      } 
      // Якщо сталася помилка з мережею чи сервером — виводиться повідомлення
      catch (err) {
        output.textContent = 'Помилка підключення до сервера';
      }
    });

    adminPanelLink.addEventListener('click', async (e)=>{
        e.preventDefault();
const savedToken = sessionStorage.getItem('token');
console.log(savedToken);

  if (!savedToken) {
    output.textContent = 'Спочатку увійдіть у систему';
    return;
  }

  // try {
  //   const res = await fetch(`${API_BASE}/admin`, {
  //     method: 'GET',
  //     headers: {
  //       'Authorization': `Bearer ${savedToken}`
  //     }
  //   });

  //   if (res.ok) {
  //     // Якщо відповідь успішна — відкриваємо /admin у новій вкладці
  //     window.location.href = `${API_BASE}/admin`;
  //   } else {
  //     const result = await res.json();
  //     output.textContent = result.message || 'Доступ заборонено';
  //   }
  // } catch (err) {
  //   output.textContent = 'Помилка з’єднання з сервером';
  // }
 fetch('http://localhost:5000/admin', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    })
    .then(res => {
      if (!res.ok) throw new Error('Не авторизовано');
      return res.text(); // Очікується, що сервер поверне HTML
    })
    .then(html => {
    // замінює весь body
      // або вставити у конкретний div:
      document.getElementById('adminContainer').innerHTML = html;
    })
    .catch(err => {
      console.error('Доступ заборонено:', err.message);
      alert('У вас немає доступу до панелі адміністратора');
    });

    });


     logoutBtn.addEventListener('click', () => {
      document.getElementById('adminContainer').innerHTML = html;
      adminPanelLink.style.display = 'none';
      hideProfile();
  });


  
  </script>
</body>
</html>
